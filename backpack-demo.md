## Backpack Demo Script

### Install Pack

#### Imports

```ts
// add new imports!
import {
    applyFingerprint,
    depsFingerprints,
    Diff,
    fingerprintImpactHandler,
    fingerprintSupport,
    FP,
    messageMaker,
    renderData,
    renderDiffSnippet,
} from "@atomist/sdm-pack-fingerprints";
```

#### Goals

We're going to create two new Goals.  One goal is used to represent the requirement that all projects are fingerprinted on every `Push`.
The second Goal will be used to verify that fingerprints always match a `target` if one has been set.

Both goals should be planned for _every_ project that contains an npm package.json file.

```ts
const backpackComplianceGoal = new GoalWithFulfillment(
    {
        uniqueName: "backpack-react-script-compliance",
        displayName: "backpack-compliance",
    },
).with(
    {
        name: "backpack-react-waiting",
    },
);

export const FingerprintGoal = new Fingerprint();
const FingerprintingGoals: Goals = goals("check fingerprints")
    .plan(FingerprintGoal, backpackComplianceGoal);

```

#### Configure Pack

The `fingerprintSupport` function creates the pack.  It has three parameters:

1.  the goal `FingerprintGoal` that will be fulfilled by running Fingerprints on each new `Push`.
2.  the callback function that generates the Fingerprint.  We can extend this callback to add new Fingerprints.
3.  a `FingerprintHandler` generator (called `fingerprintImpactHandler`), which is parameterized to support different strategies for handler projects with out of sync fingerprints.
    More on this below.

```ts
    sdm.addExtensionPacks(
        fingerprintSupport(
            FingerprintGoal,
            [
                register("backpack-react-scripts", backpackFingerprint, applyBackpackFingerprint),
            ],
            fingerprintImpactHandler(
                {
                    transformPresentation: ci => {
                        return new editModes.PullRequest(
                            `apply-target-fingerprint-${Date.now()}`,
                            `Apply fingerprint ${ci.parameters.fingerprint} to project`,
                            "Nudge generated by Atomist");
                    },
                    complianceGoal: backpackComplianceGoal,
                    messageMaker,
                    messageIdMaker:  (fp,diff) => {return null}, // return null if new messages should be posted every time
                }
            ),
        ),
    )
```

### Backpack react scripts

Our demo fingerprint works on a snippet of package.json

```json
  "backpack-react-scripts": {
    "externals": {
      "react": "v7.1",
      "react-dom": "v7.1"
    }
  },
```

We treat this whole section as one fingerprint.

## fingerprintImpactHandler

* the `transformPresentation` is a callback function that can modify how PRs are created when a fingerprint is added.
* the `complianceGoal` is an optional Goal that will be fulfilled only if all fingerprints in this project are in sync
  with their target states. The goal will fail if there are any differences.
* `messageMaker` is a callback to customize the message shown when a fingerprint is out of sync.

Included below is a sample implementation of the `messageMaker` included in the pack.  The parameters to this function 
include two possible actions that the message could embed (`params.editProject`, and `params.mutateTarget`).

```ts
export const messageMaker: MessageMaker = params => {
    return {
        attachments: [
            {
                text: params.text,
                color: "#45B254",
                fallback: "Fingerprint Update",
                mrkdwn_in: ["text"],
                actions: [
                    actionableButton(
                        { text: "Update project" },
                        params.editProject,
                        {
                            msgId: params.msgId,
                            owner: params.diff.owner,
                            repo: params.diff.repo,
                            fingerprint: params.fingerprint.name,
                        }),
                    actionableButton(
                        { text: "Set New Target" },
                        params.mutateTarget,
                        {
                            msgId: params.msgId,
                            name: params.fingerprint.name,
                            sha: params.fingerprint.sha,
                        },
                    ),
                ],
                footer: footer(),
            },
        ],
    };
};
```

## Custom Fingerprints

Adding custom Fingerprints to the impact handler can be done by implementing two functions:

```ts
const dockerBaseFingerprint: ExtractFingerprint = async (p) => {
    // COMPUTE the fingerprint here 
    return {
        name: "docker-base-image",
        abbreviation: "dbi",
        version: "0.0.1",
        data: "",
        sha: ""
    }
}

const applyDockerBaseFingerprint: ApplyFingerprint = async (p, fp) => {
    // APPLY the contents of the Fingerprint to a project
    return true;
}
```

and then plugging them in to the existing `FingerprintSupport`.  So an example using the above two functions is:

```ts
    sdm.addExtensionPacks(
        fingerprintSupport(
            FingerprintGoal,
            [
                register("backpack-react-scripts", backpackFingerprint, applyBackpackFingerprint),
            ],
            fingerprintImpactHandler(
                {
                    transformPresentation: ci => {
                        return new editModes.PullRequest(
                            `apply-target-fingerprint-${Date.now()}`,
                            `Apply fingerprint ${ci.parameters.fingerprint} to project`,
                            "Nudge generated by Atomist");
                    },
                    complianceGoal: backpackComplianceGoal,
                    messageMaker,
                    messageIdMaker:  (fp,diff) => {return null}, // return null if new messages should be posted every time
                },
                "backpack-react-scripts"
            ),
        ),
    )
```

## Demo Flow

### start with node project 0

We'll assume here that you're starting with no projects containing this section.

1.  open `package.json` and add the above section
2.  push a commit

* verify that you see Atomist run the `FingerprintGoal` on the next Push.
* Atomist will have added a Fingerprints (which you can see with `@atomist listFingerprints`) but there will be no targets for this fingerprint

> Action: run `@atomist setFingerprintGoal fingerprint=backpack-react-scripts`

* this will set a team-wide preference for this fingerprint (which you can debug with `@atomist dump preferences`)

### Projects 1 and 2

Have at least two more node projects, each having the `backpack-react-scripts` secion.  

> Action:  make some random commit changing one of the backpack-react-scripts section to be different from the goal

* Atomist will present you with two options.

> Action:  Select "Set as Target"

This will update the target (meaning that project 0 will now be out of sync with the target)

> Action:  Select "broadcast fingerprint"

Notice that the bot will send a message to the channel of project 0 nudging it to update.  You'll also see nudges in other channels for projects containing backpack-react-scripts.

### Update one of the projects

> Action: click on the "Update project" button in one of the channels

* show that the goal fingerprint is applied in a PR
* show the PR synchronizes the `backpack-react-scripts` if merged

### Add backpack-react-scripts to a project that doesn't have them

Find another project that does not have a `backpack-react-scripts` currently.

> Action: type `@atomist applyFingerprint fingerprint=backpack-react-scripts`

* demonstrate that fingerprints can also be used to add functionality into a project (join the party so to speak)

## Matt Demo Config

```ts
async function npmDepUpdated(ctx: HandlerContext, diff: Diff): Promise<any> {
    return setNewTarget(
        ctx,
        diff.to.name,
        diff.to.data.name,
        diff.to.data.version,
        diff.channel);
}

sdm.addExtensionPacks(
        fingerprintSupport(
            FingerprintGoal,
            [
                register("backpack-react-scripts", backpackFingerprint, applyBackpackFingerprint),
            ],
            fingerprintImpactHandler(
                {
                    transformPresentation: ci => {
                        return new editModes.PullRequest(
                            `apply-target-fingerprint-${Date.now()}`,
                            `Apply fingerprint ${ci.parameters.fingerprint} to project`,
                            "Nudge generated by Atomist");
                    },
                    complianceGoal: backpackComplianceGoal,
                    messageMaker,
                }
            ),
            simpleImpactHandler( npmDepUpdated, "npm-project-coordinates"),
            checkLibraryImpactHandler(),
        ),
    )
```